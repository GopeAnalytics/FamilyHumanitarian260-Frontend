<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Planner & Reminder</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="./css/styles.css" />
    <style>
      /* CSS Variables for theme colors */
      :root {
        --primary-color: #004080;
        --task-color: #28a745;
        --danger-color: #dc3545;
        --success-color: #28a745;

        /* Light theme colors */
        --bg-primary: #f4f7fc;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f9f9f9;
        --text-primary: #1a1a1a;
        --text-secondary: #636e72;
        --text-tertiary: #2c3e50;
        --border-color: #ccc;
        --border-light: #eee;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --shadow-medium: rgba(0, 0, 0, 0.1);
        --shadow-strong: rgba(0, 0, 0, 0.15);
        --hero-bg: #0c2340;
        --hero-text: white;
        --modal-overlay: rgba(0, 0, 0, 0.6);
        --footer-gradient-start: #151a21;
        --footer-gradient-end: #1f2b3d;
      }

      /* Dark theme colors */
      .dark-mode {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-tertiary: #3a3a3a;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --text-tertiary: #e0e0e0;
        --border-color: #555;
        --border-light: #444;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --shadow-medium: rgba(0, 0, 0, 0.4);
        --shadow-strong: rgba(0, 0, 0, 0.5);
        --hero-bg: #2c3e50;
        --hero-text: white;
        --modal-overlay: rgba(0, 0, 0, 0.8);
        --footer-gradient-start: #2c3e50;
        --footer-gradient-end: #34495e;
      }

      /* Task page specific styles */
      .task-container {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        text-align: center;
        min-height: 100vh;
        display: block;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .task-container * {
        box-sizing: border-box;
      }

      .task-main-content {
        padding: 20px;
        max-width: 1100px;
        margin: auto;
      }

      .task-hero {
        background-color: var(--hero-bg);
        color: var(--hero-text);
        padding: 60px 20px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        position: relative;
        transition: background-color 0.3s ease;
      }
      .task-hero .text {
        max-width: 600px;
        text-align: left;
      }
      .task-hero h1 {
        font-size: 2.5rem;
        color: white;
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .task-features {
        padding: 30px 0;
      }
      .tool-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        text-align: left;
        background: var(--bg-secondary);
        flex-wrap: wrap;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      .tool-info {
        flex-grow: 1;
        margin-left: 20px;
      }
      .tool-info h2 {
        margin: 0;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text-primary);
      }
      .tool-info .rating {
        background: var(--bg-secondary);
        color: #f90;
        border: 2px solid #f90;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        text-align: center;
        line-height: 46px;
        font-size: 1.2rem;
        font-weight: bold;
        flex-shrink: 0;
      }
      .tool-info ul {
        margin-top: 10px;
        padding-left: 20px;
        list-style: none;
      }
      .tool-info ul li {
        padding-left: 5px;
        color: var(--text-secondary);
      }
      .visit-btn,
      .add-btn {
        background: linear-gradient(45deg, #ff7a00, #ff4f00);
        border: none;
        color: white;
        padding: 12px 20px;
        font-size: 1rem;
        border-radius: 50px;
        cursor: pointer;
        text-decoration: none;
        white-space: nowrap;
        transition: transform 0.2s ease;
      }
      .visit-btn:hover,
      .add-btn:hover {
        transform: translateY(-2px);
      }

      .task-section-title {
        font-size: 1.8rem;
        color: var(--text-tertiary);
        margin-top: 50px;
        margin-bottom: 20px;
        text-align: left;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        transition: color 0.3s ease;
      }

      .task-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        text-align: left;
      }
      .task-card {
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 8px var(--shadow-color);
        border-left: 6px solid var(--task-color);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        position: relative;
      }
      .task-card.own-task {
        border-left: 6px solid var(--primary-color);
      }
      .task-card h3 {
        margin: 0 0 10px;
        color: var(--text-primary);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        transition: color 0.3s ease;
      }
      .task-card p {
        margin: 5px 0;
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }
      .card-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .complete-btn {
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: bold;
        flex-grow: 1;
        transition: transform 0.2s ease;
        background: var(--task-color);
      }
      .complete-btn:hover {
        transform: translateY(-1px);
      }
      .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 5px;
        color: var(--text-secondary);
        transition: color 0.3s ease, transform 0.2s ease;
      }
      .icon-btn:hover {
        color: var(--text-primary);
        transform: scale(1.1);
      }

      .task-summaries {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-top: 40px;
      }
      .task-summary {
        background: var(--bg-secondary);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--shadow-medium);
        text-align: left;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }
      .task-summary h2 {
        color: var(--primary-color);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .task-summary p {
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }
      .task-summary strong {
        color: var(--text-primary);
        transition: color 0.3s ease;
      }
      .progress-bar {
        background: var(--border-color);
        border-radius: 20px;
        overflow: hidden;
        margin-top: 10px;
        transition: background-color 0.3s ease;
      }
      .progress-bar-inner {
        height: 20px;
        transition: width 0.5s ease-in-out;
        background: var(--task-color);
      }

      .task-footer-banner {
        width: 100%;
        margin-top: 40px;
        padding: 30px;
        background: linear-gradient(
          90deg,
          var(--footer-gradient-start) 0%,
          var(--footer-gradient-end) 100%
        );
        color: white;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 20px;
        border-radius: 12px;
        transition: background 0.3s ease;
      }
      .footer-logo {
        width: 100px;
        height: auto;
        filter: brightness(1.2);
      }
      .footer-text h2 {
        margin: 0;
        font-size: 1.4em;
        color: white;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .footer-text p {
        margin: 5px 0 0;
        font-size: 0.95em;
        color: #d1d1d1;
      }

      /* MODAL STYLES */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--modal-overlay);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        transition: background-color 0.3s ease;
      }
      .modal-content {
        background: var(--bg-secondary);
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        position: relative;
        transition: background-color 0.3s ease;
      }
      .modal-content h2 {
        margin-top: 0;
        color: var(--primary-color);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        border: none;
        background: none;
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }
      .modal-close:hover {
        color: var(--text-primary);
      }
      .modal-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .modal-form label {
        font-weight: 600;
        text-align: left;
        color: var(--text-primary);
        transition: color 0.3s ease;
      }
      .modal-form input,
      .modal-form textarea,
      .modal-form select {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, border-color 0.3s ease,
          color 0.3s ease;
      }
      .modal-form input:focus,
      .modal-form textarea:focus,
      .modal-form select:focus {
        outline: none;
        border-color: var(--primary-color);
      }
      .modal-form button {
        margin-top: 10px;
        font-size: 1rem;
      }

      .datetime-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      /* NOTIFICATION STYLES */
      .notification-bell {
        position: absolute;
        top: 25px;
        right: 30px;
        cursor: pointer;
      }
      .notification-bell .icon {
        font-size: 28px;
        color: white;
      }
      .notification-bell .badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: var(--danger-color);
        color: white;
        border-radius: 50%;
        padding: 2px 7px;
        font-size: 12px;
        font-weight: bold;
        display: none;
      }
      .notification-panel {
        display: none;
        position: absolute;
        top: 50px;
        right: 0;
        width: 320px;
        background: var(--bg-secondary);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-strong);
        z-index: 100;
        max-height: 400px;
        overflow-y: auto;
        color: var(--text-primary);
        text-align: left;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }
      .notification-panel h4 {
        padding: 12px 15px;
        margin: 0;
        border-bottom: 1px solid var(--border-light);
        color: var(--text-primary);
        transition: border-color 0.3s ease, color 0.3s ease;
      }
      .notification-panel ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .notification-panel li {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-light);
        font-size: 0.9rem;
        color: var(--text-secondary);
        transition: border-color 0.3s ease, color 0.3s ease;
      }
      .notification-panel li:last-child {
        border-bottom: none;
      }
      .notification-panel li strong {
        color: var(--text-primary);
        transition: color 0.3s ease;
      }

      /* TOAST STYLES */
      .task-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 25px;
        border-radius: 50px;
        color: white;
        font-weight: bold;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
      }
      .task-toast.show {
        opacity: 1;
        bottom: 40px;
      }
      .task-toast.success {
        background-color: var(--success-color);
      }
      .task-toast.error {
        background-color: var(--danger-color);
      }

      /* Theme Toggle Button */
      .theme-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: 0 4px 12px var(--shadow-medium);
        z-index: 1000;
        transition: transform 0.2s ease, box-shadow 0.3s ease;
      }
      .theme-toggle:hover {
        transform: scale(1.1);
      }

      @media (max-width: 768px) {
        .task-hero {
          justify-content: center;
          text-align: center;
        }
        .task-hero .text {
          text-align: center;
        }
        .tool-card,
        .task-footer-banner {
          flex-direction: column;
          text-align: center;
          gap: 20px;
        }
        .task-summaries {
          grid-template-columns: 1fr;
        }
        .notification-bell {
          top: 15px;
          right: 15px;
        }
        .task-main-content {
          padding-top: 10px;
        }
        .theme-toggle {
          bottom: 80px;
          right: 15px;
        }
        .datetime-group {
          grid-template-columns: 1fr;
        }
      }

      .creator-badge {
        position: absolute;
        top: 10px;
        right: 15px;
        background: rgba(102, 126, 234, 0.8);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
      }
      .completed-text {
        color: var(--success-color);
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 30px;
        background: rgba(40, 167, 69, 0.1);
      }
    </style>
  </head>
  <body>
    <header class="top-nav">
      <div class="logo">
        <img
          src="logoR.png"
          alt="Fh260 Logo"
          style="height: 30px; margin-right: 15px"
        />
        <h1>Fh260</h1>
      </div>

      <!-- Desktop Navigation -->
      <nav class="desktop-nav">
        <a href="home.html">Home</a>
        <a href="apply.html">Apply</a>
        <a href="downloads.html">Downloads</a>
        <a href="receipts.html">Receipts</a>
        <a href="Task.html" class="active">Reminder</a>
        <a href="fundsTransfer.html">Transfers</a>
      </nav>

      <!-- Desktop User Profile (visible on desktop only) -->
      <div class="user-profile">
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user"></i>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
          <a href="#" id="viewProfileBtn"
            ><i class="fas fa-edit"></i> View/Edit Profile</a
          >
          <a href="#" id="logoutBtn"
            ><i class="fas fa-sign-out-alt"></i> Logout</a
          >
        </div>
      </div>

      <!-- Mobile Controls Container (groups user profile and hamburger on mobile) -->
      <div class="mobile-controls">
        <div class="user-profile">
          <div class="user-icon" id="userIconMobile">
            <i class="fas fa-user"></i>
          </div>
          <div class="profile-dropdown" id="profileDropdownMobile">
            <a href="#" id="viewProfileBtnMobile"
              ><i class="fas fa-edit"></i> View/Edit Profile</a
            >
            <a href="#" id="logoutBtnMobile"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </div>
        </div>

        <!-- Hamburger Menu Button -->
        <div class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <!-- Mobile Navigation Menu -->
      <nav id="nav-menu">
        <div class="close-nav" id="close-nav">
          <i class="fas fa-times"></i>
        </div>
        <a href="home.html">Home</a>
        <a href="apply.html">Apply</a>
        <a href="downloads.html">Downloads</a>
        <a href="receipts.html">Receipts</a>
        <a href="Task.html" class="active">Reminder</a>
        <a href="fundsTransfer.html">Transfers</a>
      </nav>
    </header>

    <!-- Task content wrapped in task-container to isolate styles -->
    <div class="task-container">
      <div class="task-main-content">
        <section class="task-hero">
          <div class="text">
            <h1>üìÖ Task Management Tool</h1>
            <p>Viewing all tasks from your country</p>
          </div>
          <div class="notification-bell">
            <span class="icon">üîî</span>
            <span class="badge" id="notificationBadge"></span>
            <div class="notification-panel" id="notificationPanel">
              <h4>Upcoming Events (24h)</h4>
              <ul id="notificationList"></ul>
            </div>
          </div>
        </section>

        <section class="task-features">
          <div class="tool-card">
            <div class="tool-info">
              <h2>Task <span class="rating">100%</span></h2>
              <ul>
                <li>‚úîÔ∏è Tracking Title</li>
                <li>‚úîÔ∏è Description</li>
                <li>‚úîÔ∏è Tracking Date & Time</li>
                <li>‚úîÔ∏è Tracking Priority</li>
              </ul>
            </div>
            <button class="add-btn" onclick="openModalForCreate('task')">
              Add Task +
            </button>
          </div>
        </section>

        <h2 class="task-section-title">üìå All Tasks from Your Country</h2>
        <div class="task-list" id="taskList"><p>Loading...</p></div>

        <div class="task-summaries">
          <div class="task-summary">
            <h2>üìä Task Completion Summary</h2>
            <p>
              Completed: <strong id="completedTaskCount">0</strong> of
              <strong id="totalTaskCount">0</strong>
            </p>
            <div class="progress-bar">
              <div class="progress-bar-inner" id="taskProgressBar"></div>
            </div>
          </div>
        </div>

        <div class="task-footer-banner">
          <img
            src="https://cdn.worldvectorlogo.com/logos/monday-1.svg"
            alt="Monday.com Logo"
            class="footer-logo"
          />
          <div class="footer-text">
            <h2>Record, Remember, and Do!</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for adding/editing tasks -->
    <div class="modal-overlay" id="formModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        <h2 id="modalTitle"></h2>
        <form id="modalForm" class="modal-form"></form>
      </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h3>Edit Profile</h3>
        <div class="profile-picture">
          <img
            id="profileImage"
            src="https://via.placeholder.com/80"
            alt="Profile"
            class="initials-circle"
          />
          <input
            type="file"
            id="profileUpload"
            style="display: none"
            accept="image/*"
          />
          <button class="upload-btn" id="uploadBtn">
            <i class="fas fa-upload"></i> Upload
          </button>
        </div>
        <form id="profileForm">
          <div class="form-group">
            <label for="fullName">Full Name</label>
            <input type="text" id="fullName" readonly />
          </div>
          <div class="form-group">
            <label for="role">Role</label>
            <input type="text" id="role" placeholder="Enter your role" />
          </div>
          <div class="form-group">
            <label for="bio">Bio/Short Description</label>
            <textarea
              id="bio"
              placeholder="Tell us about yourself..."
            ></textarea>
          </div>
          <div class="form-group theme-switcher">
            <label>Theme</label>
            <i class="fas fa-sun" id="themeIcon"></i>
          </div>
          <div class="modal-buttons">
            <button type="submit" class="save-btn">Save Changes</button>
            <button type="button" class="cancel-btn" id="cancelBtn">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <footer>
      <p>&copy; 2025 Fh260. All rights reserved.</p>
      <div class="footer-links">
        <a href="sign.html">Sign In</a> | <a href="index.html">Back Page</a> |
        <a href="admin.html">Admin</a>
      </div>
    </footer>
    <script src="js/global-nav.js"></script>
    <script src="js/profile-handler.js"></script>

    <!-- Task page specific JavaScript -->
    <script>
      const token = localStorage.getItem("token");
      const BASE_URL = "http://localhost:3000";
      let currentUserId = null;

      // --- UTILITY & HELPER FUNCTIONS ---
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `task-toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add("show"), 10);
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
      }

      // FIXED: Better API request handling without reading response multiple times
      async function apiRequest(endpoint, method = "GET", body = null) {
        try {
          const options = {
            method,
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          };
          if (body) options.body = JSON.stringify(body);

          console.log(
            `Making API request: ${method} ${BASE_URL}/api${endpoint}`
          );

          const response = await fetch(`${BASE_URL}/api${endpoint}`, options);
          console.log(`Response status: ${response.status}`);

          // Clone the response to read it as text first
          const responseClone = response.clone();
          let responseData;

          try {
            responseData = await response.json();
          } catch (e) {
            // If JSON parsing fails, try to read as text
            const textResponse = await responseClone.text();
            throw new Error(
              `Server error (${response.status}): ${textResponse.substring(
                0,
                100
              )}...`
            );
          }

          if (!response.ok) {
            const errorMessage =
              responseData.message ||
              responseData.error ||
              "API request failed";
            throw new Error(errorMessage);
          }

          console.log("API response data:", responseData);
          return responseData;
        } catch (error) {
          console.error("API request error:", error);
          showToast(error.message || "An unexpected error occurred.", "error");
          return null;
        }
      }

      // --- MODAL & FORM LOGIC ---
      const modal = document.getElementById("formModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalForm = document.getElementById("modalForm");
      let currentEdit = { type: null, id: null };

      function closeModal() {
        modal.style.display = "none";
      }

      function getFormFields(type) {
        return `
          <input type="hidden" name="id">
          <label for="title">Title</label><input type="text" id="title" name="title" required>
          <label for="description">Description</label><textarea id="description" name="description" rows="3"></textarea>
          <div class="datetime-group">
            <div>
              <label for="dueDate">Due Date</label><input type="date" id="dueDate" name="dueDate" required>
            </div>
            <div>
              <label for="dueTime">Due Time</label><input type="time" id="dueTime" name="dueTime" required>
            </div>
          </div>
          <label for="priority">Priority</label><select id="priority" name="priority"><option>Low</option><option>Medium</option><option>High</option></select>
          <label for="reminder">Reminder</label><select id="reminder" name="reminder" required><option value="30min">30 Mins Before</option><option value="1hr">1 Hour Before</option><option value="24hr">24 Hours Before</option></select>
          <button type="submit" class="add-btn">Save Task</button>`;
      }

      async function openModalForEdit(type, id) {
        const data = await apiRequest(`/tasks/${id}`);
        if (!data) return;

        currentEdit = { type, id };
        modalTitle.textContent = `Edit Task`;
        modalForm.innerHTML = getFormFields(type);

        // Map the API response to form fields
        const fieldMappings = {
          title: "title",
          description: "description",
          dueDate: "dueDate",
          dueTime: "dueTime",
          priority: "priority",
          reminder: "reminder",
        };

        Object.keys(fieldMappings).forEach((apiField) => {
          const formField = fieldMappings[apiField];
          const input = modalForm.querySelector(`[name="${formField}"]`);
          if (input && data[apiField] !== undefined) {
            input.value = data[apiField];
          }
        });

        modal.style.display = "flex";
      }

      function openModalForCreate(type) {
        currentEdit = { type, id: null };
        modalTitle.textContent = `Add New Task`;
        modalForm.innerHTML = getFormFields(type);
        modal.style.display = "flex";
      }

      modalForm.onsubmit = async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target).entries());
        const { type, id } = currentEdit;

        const endpoint = id ? `/tasks/${id}` : `/tasks`;
        const method = id ? "PUT" : "POST";

        const result = await apiRequest(endpoint, method, formData);
        if (result) {
          showToast(result.message);
          closeModal();
          refreshAllData();
        }
      };

      // --- DATA RENDERING ---
      function formatDate(dateString) {
        if (!dateString) return "No date set";
        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return "Invalid date";
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            weekday: "short",
          });
        } catch (error) {
          console.error("Date formatting error:", error);
          return "Date error";
        }
      }

      function formatTime(timeString) {
        if (!timeString) return "No time set";
        try {
          const [hours, minutes] = timeString.split(":");
          const hour24 = parseInt(hours, 10);
          const minute = parseInt(minutes, 10);
          const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
          const ampm = hour24 >= 12 ? "PM" : "AM";
          const minuteStr = minute.toString().padStart(2, "0");
          return `${hour12}:${minuteStr} ${ampm}`;
        } catch (error) {
          console.error("Time formatting error:", error);
          return "Time error";
        }
      }

      function renderTasks(tasks) {
        const taskList = document.getElementById("taskList");

        if (!tasks || tasks.length === 0) {
          taskList.innerHTML =
            "<p>No pending tasks found for your country.</p>";
          return;
        }

        taskList.innerHTML = tasks
          .map((task) => {
            return `
              <div class="task-card ${
                task.user_id === currentUserId ? "own-task" : ""
              }">
                ${
                  task.user_id === currentUserId
                    ? '<div class="creator-badge">Your Task</div>'
                    : ""
                }
                <h3>${task.title} ${
              task.user_id !== currentUserId
                ? `<small>(by ${task.creator_name || "Unknown"})</small>`
                : ""
            }</h3>
                <p><strong>Due Date:</strong> ${formatDate(task.due_date)}</p>
                <p><strong>Due Time:</strong> ${formatTime(task.due_time)}</p>
                <p><strong>Priority:</strong> ${task.priority}</p>
                <p><strong>Status:</strong> ${task.status || "pending"}</p>
                ${
                  task.description
                    ? `<p><strong>Description:</strong> ${task.description}</p>`
                    : ""
                }
                
                ${
                  task.user_id === currentUserId
                    ? `
                  <div class="card-actions">
                    ${
                      task.status !== "completed"
                        ? `<button class="complete-btn" data-type="task" data-id="${task.id}">‚úì Complete</button>`
                        : `<span class="completed-text">‚úì Completed</span>`
                    }
                    <button class="icon-btn" onclick="openModalForEdit('task', ${
                      task.id
                    })" title="Edit Task">‚úèÔ∏è</button>
                    <button class="icon-btn" onclick="handleDelete('task', ${
                      task.id
                    })" title="Delete Task">üóëÔ∏è</button>
                  </div>`
                    : ""
                }
              </div>
            `;
          })
          .join("");
      }

      function renderTaskSummary(taskSummary) {
        if (taskSummary) {
          document.getElementById("completedTaskCount").textContent =
            taskSummary.completed;
          document.getElementById("totalTaskCount").textContent =
            taskSummary.total;
          document.getElementById(
            "taskProgressBar"
          ).style.width = `${taskSummary.completionRate}%`;
        }
      }

      // --- NOTIFICATION LOGIC ---
      async function fetchAndShowNotifications() {
        const events = await apiRequest("/notifications/upcoming");
        const badge = document.getElementById("notificationBadge");
        const list = document.getElementById("notificationList");
        if (!events) return;
        badge.style.display = events.length > 0 ? "block" : "none";
        badge.textContent = events.length;
        list.innerHTML = events.length
          ? events
              .map(
                (event) =>
                  `<li><strong>${event.title}</strong> ${
                    event.creator_name ? `(by ${event.creator_name})` : ""
                  }<br><small>Today at ${new Date(
                    event.event_time
                  ).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  })}</small></li>`
              )
              .join("")
          : "<li>No upcoming events.</li>";
      }

      // --- EVENT HANDLERS ---
      async function handleDelete(type, id) {
        if (confirm(`Are you sure you want to delete this ${type}?`)) {
          const result = await apiRequest(`/${type}s/${id}`, "DELETE");
          if (result) {
            showToast(result.message);
            refreshAllData();
          }
        }
      }

      document.body.addEventListener("click", async (event) => {
        if (event.target.matches(".complete-btn")) {
          const button = event.target;
          const result = await apiRequest(
            `/tasks/${button.dataset.id}/complete`,
            "PUT"
          );
          if (result) {
            showToast(result.message);
            refreshAllData();
          }
        }
      });

      // --- INITIALIZATION ---
      async function refreshAllData() {
        const [tasks, taskSummary] = await Promise.all([
          apiRequest("/tasks/pending"),
          apiRequest("/tasks/summary"),
        ]);

        renderTasks(tasks);
        renderTaskSummary(taskSummary);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        if (!token) {
          document.body.innerHTML =
            "<h1>Please log in to use the Task Manager.</h1>";
          setTimeout(() => {
            window.location.href = "sign.html";
          }, 2000);
          return;
        }

        // Get current user ID from JWT token
        try {
          const payload = JSON.parse(atob(token.split(".")[1]));
          currentUserId = payload.Id || payload.id || payload.userId;
          console.log("Current user ID:", currentUserId);
        } catch (error) {
          console.error("Failed to parse user ID from token:", error);
        }

        refreshAllData();
        fetchAndShowNotifications();
        setInterval(fetchAndShowNotifications, 60000);

        const notificationBell = document.querySelector(".notification-bell");
        const notificationPanel = document.getElementById("notificationPanel");
        notificationBell.addEventListener("click", (e) => {
          e.stopPropagation();
          notificationPanel.style.display =
            notificationPanel.style.display === "block" ? "none" : "block";
        });

        window.addEventListener("click", () => {
          if (notificationPanel.style.display === "block") {
            notificationPanel.style.display = "none";
          }
        });

        // Close modal when clicking outside
        window.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });
      });
    </script>
  </body>
</html>
