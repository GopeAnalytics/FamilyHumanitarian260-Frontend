<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta property="og:title" content="Fh260-Africa" />
    <meta
      property="og:description"
      content="Digitalising Fh260-Africa Operations"
    />
    <meta property="og:image" content="https://fh260.org/og-fhlogo.jpeg" />
    <meta property="og:url" content="https://fh260.org" />
    <title>Fund Request Form</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/apply-styles.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  </head>
  <body>
    <header class="top-nav">
      <div class="logo">
        <img
          src="logoR.png"
          alt="Fh260 Logo"
          style="height: 30px; margin-right: 15px"
        />
        <h1>Fh260</h1>
      </div>

      <!-- Desktop Navigation -->
      <nav class="desktop-nav">
        <a href="home.html">Home</a>
        <a href="apply.html" class="active">Apply</a>
        <a href="downloads.html">Downloads</a>
        <a href="receipts.html">Receipts</a>
        <a href="Task.html">Reminder</a>
      </nav>

      <!-- Desktop User Profile (visible on desktop only) -->
      <div class="user-profile">
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user"></i>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
          <a href="#" id="viewProfileBtn"
            ><i class="fas fa-edit"></i> View/Edit Profile</a
          >
          <a href="#" id="logoutBtn"
            ><i class="fas fa-sign-out-alt"></i> Logout</a
          >
        </div>
      </div>

      <!-- Mobile Controls Container (groups user profile and hamburger on mobile) -->
      <div class="mobile-controls">
        <div class="user-profile">
          <div class="user-icon" id="userIconMobile">
            <i class="fas fa-user"></i>
          </div>
          <div class="profile-dropdown" id="profileDropdownMobile">
            <a href="#" id="viewProfileBtnMobile"
              ><i class="fas fa-edit"></i> View/Edit Profile</a
            >
            <a href="#" id="logoutBtnMobile"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </div>
        </div>

        <!-- Hamburger Menu Button -->
        <div class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <!-- Mobile Navigation Menu -->
      <nav id="nav-menu">
        <div class="close-nav" id="close-nav">
          <i class="fas fa-times"></i>
        </div>
        <a href="home.html">Home</a>
        <a href="apply.html" class="active">Apply</a>
        <a href="downloads.html">Downloads</a>
        <a href="receipts.html">Receipts</a>
        <a href="Task.html">Reminder</a>
      </nav>
    </header>

    <div class="container">
      <h1>Fund Request</h1>

      <label for="requestType">Request Type:</label>
      <select id="requestType">
        <option value="New">New</option>
        <option value="Reimbursement">Reimbursement</option>
      </select>
      <!-- Reimbursement Section -->
      <div id="reimbursementButtons" class="hidden space-y-4">
        <div id="attachmentsContainer" class="space-y-2"></div>
        <div class="flex gap-2">
          <button
            id="uploadButton"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Upload
          </button>
          <button
            id="photoButton"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Photo
          </button>
          <button
            id="reconcileButton"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Reconcile
          </button>
        </div>
      </div>

      <label for="category">Category:</label>
      <select id="category">
        <option value="" disabled selected>Select category</option>
        <option value="Fuel">Fuel</option>
        <option value="Borehole Supplies">Borehole Supplies</option>
        <option value="Construction">Construction</option>
        <option value="Paper Works">Paper works</option>
        <option value="Office">Office</option>
        <option value="Permits">Permits</option>
        <option value="Internet/Electricity">Internet/Electricity</option>
        <option value="Rent">Rent</option>
        <option value="Vehicle Repair">Vehicle Repair</option>
        <option value="Expeditions">Expeditions</option>
        <option value="Transport">Transport</option>
        <option value="Meals">Meals</option>
        <option value="Accommodations">Accommodations</option>
        <option value="Projects">Projects</option>
        <option value="Training">Training</option>
        <option value="Vehicle Service">Vehicle Service</option>
        <option value="Other">Other</option>
      </select>

      <label for="subCategory">Sub-category:</label>
      <select id="subCategory">
        <option value="None">None</option>
      </select>
      <input
        type="text"
        id="otherSubCategory"
        class="hidden"
        placeholder="Specify Other Sub-category"
      />

      <button class="add-model-button" onclick="addModel()">
        Add sub-category
      </button>

      <div class="models"></div>
      <div id="moneyAtHandContainer" style="margin-top: 20px">
        <label for="moneyAtHand">Money at Hand (Optional):</label>
        <input
          type="number"
          id="moneyAtHand"
          name="moneyAtHand"
          placeholder="No money at hand? Input 0"
          value="0"
          min="0"
          oninput="updateTotals()"
        />
      </div>
      <div id="transactionCostContainer" style="margin-top: 20px">
        <label for="transactionCost">Transaction Cost (Optional):</label>
        <input
          type="number"
          id="transactionCost"
          name="transactionCost"
          placeholder="Enter transaction cost"
        />
        <input type="hidden" id="currencyCode" name="currencyCode" />
        <div id="summary" class="hidden"></div>
        <button id="proceedButton" onclick="proceed()">Proceed</button>
      </div>
      <div id="totalRequestContainer" style="margin-top: 20px">
        <label for="totalRequest">Total Request:</label>
        <input type="text" id="totalRequest" name="totalRequest" readonly />
      </div>

      <button id="sendReceiptButton" onclick="sendAndDownloadReceipt()">
        Send and Download Receipt
      </button>

      <div id="feedback" style="display: none"></div>
    </div>

    <div id="reconcileContainer"></div>
    <div id="profileModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h3>Edit Profile</h3>
        <div class="profile-picture">
          <img
            id="profileImage"
            src="https://via.placeholder.com/80"
            alt="Profile"
            class="initials-circle"
          />
          <input
            type="file"
            id="profileUpload"
            style="display: none"
            accept="image/*"
          />
          <button class="upload-btn" id="uploadBtn">
            <i class="fas fa-upload"></i> Upload
          </button>
        </div>
        <form id="profileForm">
          <div class="form-group">
            <label for="fullName">Full Name</label>
            <input type="text" id="fullName" readonly />
          </div>
          <div class="form-group">
            <label for="role">Role</label>
            <input type="text" id="role" placeholder="Enter your role" />
          </div>
          <div class="form-group">
            <label for="bio">Bio/Short Description</label>
            <textarea
              id="bio"
              placeholder="Tell us about yourself..."
            ></textarea>
          </div>
          <div class="form-group theme-switcher">
            <label>Theme</label>
            <i class="fas fa-sun" id="themeIcon"></i>
          </div>
          <div class="modal-buttons">
            <button type="submit" class="save-btn">Save Changes</button>
            <button type="button" class="cancel-btn" id="cancelBtn">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
    <footer>
      <p>&copy; 2025 Fh260. All rights reserved.</p>
      <div class="footer-links">
        <a href="sign.html">Sign In</a> | <a href="index.html">Back Page</a> |
        <a href="admin.html">Admin</a>
      </div>
    </footer>
    <script src="global-nav.js"></script>
    <script src="profile-handler.js"></script>

    <script>
      const BASE_URL = "http://localhost:3000";
      // Apply saved theme on page load
      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        if (savedTheme === "dark") {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }
      });
      // Get the user's country from localStorage to determine currency
      function getUserCurrency() {
        const user = JSON.parse(localStorage.getItem("user")) || {
          country: "Unknown",
        };
        const countryToCurrency = {
          Kenya: "KES",
          Tanzania: "TZS",
          Uganda: "UGX",
          Zambia: "ZMW",
          Ghana: "GHS",
        };

        // Default to USD if country not in the list
        return countryToCurrency[user.country] || "USD";
      }

      // Create a currency formatter that uses the user's currency
      function createCurrencyFormatter() {
        const currencyCode = getUserCurrency();
        return new Intl.NumberFormat(undefined, {
          style: "currency",
          currency: currencyCode,
          minimumFractionDigits: 2,
        });
      }

      // Handle category change and populate sub-categories
      document
        .getElementById("category")
        .addEventListener("change", function () {
          const subCategory = document.getElementById("subCategory");
          subCategory.innerHTML = "";

          const selectedCategory = this.value;

          const subCategories = {
            Fuel: ["Full Tank", "Top up", "One Month Full tank", "Other"],
            "Paper Works": [
              "Government",
              "Government-eCitizen Kenya",
              "Labor Charge(Service fee)",
              "Other",
            ],
            Office: [
              "Printer",
              "Rim Papers",
              "Pen",
              "Tona",
              "Catridge",
              "Ink",
              "Stamp",
              "Other",
            ],
            "Borehole Supplies": [
              "Afri dev Pump",
              "Mark II Pump",
              "Rods",
              "Pump Installation",
              "Plaques",
              "Drill bits",
              "Rivets",
              "Casing Pipes",
              "Targid Glue",
              "Grouting",
              "Centralizers",
              "Pipes",
              "Rubber",
              "Riser Pipes (Afri Dev Pipes)",
              "Galvanized Iron Pipes(GI)",
              "Mud Pumps",
              "Water Hoses",
              "Filters",
              "Bearings",
              "Grease",
              "Labor Charge(Service fee)",
              "Other",
            ],
            Construction: [
              "Cement",
              "Sand",
              "Gravel",
              "Bricks",
              "Iron Sheets",
              "Nails",
              "Timber",
              "Labor Charge(Service fee)",
              "Other",
            ],
            Permits: [
              "Geological Survey",
              "Borehole Permits",
              "Drilling Permits",
              "Labor Charge(Service fee)",
              "Other",
            ],
            "Internet/Electricity": ["Monthly Charge", "Other"],
            Rent: ["Monthly", "Other"],
            "Vehicle Repair": [
              "Tires",
              "Alternator",
              "Battery",
              "Oil Change",
              "Brake Pads",
              "Suspension",
              "Exhaust Pipe",
              "GearBox",
              "Speedometer",
              "Oil filters",
              "Rings",
              "Air filters",
              "Grease",
              "Labor Charge(Service fee)",
              "Other",
            ],
            Expeditions: ["Car Hire", "Labor Charge(Service fee)", "Other"],
            Transport: ["Labor Charge(Service fee)", "Other"],
            Meals: ["Lunch", "Dinner", "Snacks", "Other"],
            Accommodations: [
              "Hotel Rooms",
              "Labor Charge(Service fee)",
              "Other",
            ],
            Projects: [
              "Drilling Hand Boreholes",
              "Drilling Solar Boreholes",
              "Constructing Schools",
              "Labor Charge(Service fee)",
              "Other",
            ],
            Training: [
              "Sheldon's Visit",
              "General Meeting ",
              "Leadership Training",
              "Transport",
              "Other",
            ],
            "Vehicle Service": [
              "Body Repair",
              "Body Paint",
              "Labor Charge(Service fee)",
              "Engine Change",
              "Insurance",
              "Other",
            ],
            Other: ["Other"],
          };
          // Always start with "None"
          const options = ["None"];

          if (subCategories[selectedCategory]) {
            options.push(...subCategories[selectedCategory]);
          } else {
            options.push("Other"); // Fallback if category not found
          }

          // Populate dropdown
          options.forEach((option) => {
            const opt = document.createElement("option");
            opt.value = option;
            opt.textContent = option;
            subCategory.appendChild(opt);
          });
        });

      // Show/hide reimbursement buttons
      document
        .getElementById("requestType")
        .addEventListener("change", function () {
          const reimbursementButtons = document.getElementById(
            "reimbursementButtons"
          );
          this.value === "Reimbursement"
            ? reimbursementButtons.classList.remove("hidden")
            : reimbursementButtons.classList.add("hidden");
        });

      // Show "Other" input field if "Other" is selected
      document
        .getElementById("subCategory")
        .addEventListener("change", function () {
          const otherInput = document.getElementById("otherSubCategory");
          this.value === "Other"
            ? otherInput.classList.remove("hidden")
            : otherInput.classList.add("hidden");
        });

      function addModel() {
        const reqType = document.getElementById("requestType");
        const category = document.getElementById("category");
        const subCategory = document.getElementById("subCategory");
        const otherSubCategoryInput =
          document.getElementById("otherSubCategory");

        let selectedModel = subCategory.value;

        if (selectedModel === "Other") {
          selectedModel = otherSubCategoryInput.value.trim();
          if (!selectedModel) {
            alert("Please enter a sub-category name.");
            return;
          }
          selectedModel = `Other: ${selectedModel}`; // Prepend "Other: " to distinguish it
        }

        // Lock the dropdowns after first sub-category is added
        reqType.disabled = true;
        category.disabled = true;

        const modelContainer = document.createElement("div");
        modelContainer.className = "subcategory-container";
        modelContainer.innerHTML = `
        <div class="subcategory-header">
            <h2>${selectedModel}</h2>
            <button class="remove-button" onclick="removeSubCategory(this)">Remove</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Quantity</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" placeholder="Description"></td>
                    <td><input type="number" class="amount" placeholder="Amount" oninput="updateTotals()"></td>
                    <td><input type="number" class="quantity" placeholder="Quantity" oninput="updateTotals()"></td>
                    <td><button class="remove-item-button" onclick="removeItem(this)">Remove</button></td>
                </tr>
            </tbody>
        </table>
        <button class="add-item-button" onclick="addItem(this)">Add Item</button>
    `;
        document.querySelector(".models").appendChild(modelContainer);

        // Reset and hide the "Other" input field
        otherSubCategoryInput.value = "";
        otherSubCategoryInput.classList.add("hidden");
        subCategory.value = "None"; // Reset dropdown
      }

      function addItem(button) {
        const tbody = button.previousElementSibling.querySelector("tbody");
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
        <td><input type="text" placeholder="Description"></td>
        <td><input type="number" class="amount" placeholder="Amount" oninput="updateTotals()"></td>
        <td><input type="number" class="quantity" placeholder="Quantity" oninput="updateTotals()"></td>
        <td><button class="remove-item-button" onclick="removeItem(this)">Remove</button></td>
    `;
        tbody.appendChild(newRow);
      }

      function removeItem(button) {
        const row = button.closest("tr");
        const tbody = row.parentElement;
        if (tbody.rows.length > 1) {
          row.remove();
        } else {
          alert("You must have at least one item in a sub-category.");
        }
        updateTotals();
      }

      //UploadButton event listener:
      document
        .getElementById("uploadButton")
        .addEventListener("click", async function () {
          const fileInput = document.createElement("input");
          fileInput.type = "file";

          fileInput.addEventListener("change", async function () {
            const file = fileInput.files[0];
            if (!file) return;

            // Show loading state
            this.disabled = true;

            try {
              const formData = new FormData();
              formData.append("attachment", file);

              const response = await fetch(`${BASE_URL}/api/upload`, {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
                body: formData,
              });

              const data = await response.json();

              if (response.ok) {
                createFileAttachment(file.name, data.driveLink, "file");
              } else {
                alert("Upload failed: " + (data.error || "Unknown error"));
              }
            } catch (error) {
              console.error("Upload error:", error);
              alert("File upload failed");
            } finally {
              this.disabled = false;
            }
          });

          fileInput.click();
        });

      function createFileAttachment(fileName, driveLink, type) {
        const attachmentItem = document.createElement("div");
        attachmentItem.className = "attachment-item";
        attachmentItem.innerHTML = `
    <div class="file-info">
      <span class="file-name">${fileName}</span>
      <button onclick="this.parentElement.parentElement.remove()">✕</button>
    </div>
    <input type="hidden" name="attachments[]" 
           data-type="${type}"
           data-filename="${fileName}"
           value="${driveLink}">
  `;
        document
          .getElementById("attachmentsContainer")
          .appendChild(attachmentItem);
      }
      // Photo Capture Modal
      document
        .getElementById("photoButton")
        .addEventListener("click", async function () {
          // Create modal overlay with improved positioning and styling
          const modal = document.createElement("div");
          modal.style.position = "fixed";
          modal.style.top = "0";
          modal.style.left = "0";
          modal.style.width = "100%";
          modal.style.height = "100%";
          modal.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
          modal.style.display = "flex";
          modal.style.alignItems = "center";
          modal.style.justifyContent = "center";
          modal.style.zIndex = "1000";

          // Camera container with better styling
          const cameraContainer = document.createElement("div");
          cameraContainer.style.backgroundColor = "white";
          cameraContainer.style.borderRadius = "8px";
          cameraContainer.style.padding = "20px";
          cameraContainer.style.width = "90%";
          cameraContainer.style.maxWidth = "600px";
          cameraContainer.style.boxShadow = "0 4px 15px rgba(0,0,0,0.2)";

          cameraContainer.innerHTML = `
    <h4 style="font-size: 20px; margin-bottom: 15px; font-weight: 600;">Take Photo</h4>
    <div class="video-preview" style="background-color: black; aspect-ratio: 16/9; width: 100%; margin-bottom: 15px;"></div>
    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
      <button class="cancel-btn" style="padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Cancel
      </button>
      <button class="capture-btn" style="padding: 8px 16px; background-color: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Capture
      </button>
    </div>
  `;

          modal.appendChild(cameraContainer);
          document.body.appendChild(modal);

          navigator.mediaDevices
            .getUserMedia({ video: true })
            .then(function (stream) {
              const video = document.createElement("video");
              video.style.width = "100%";
              video.style.height = "100%";
              video.style.objectFit = "contain";
              video.srcObject = stream;
              video.play();

              cameraContainer
                .querySelector(".video-preview")
                .appendChild(video);

              // Capture handler
              cameraContainer
                .querySelector(".capture-btn")
                .addEventListener("click", function () {
                  const canvas = document.createElement("canvas");
                  const context = canvas.getContext("2d");
                  canvas.width = video.videoWidth;
                  canvas.height = video.videoHeight;
                  context.drawImage(video, 0, 0, canvas.width, canvas.height);

                  canvas.toBlob(async (blob) => {
                    try {
                      const formData = new FormData();
                      formData.append(
                        "attachment",
                        blob,
                        `photo_${Date.now()}.png`
                      );

                      const response = await fetch(`${BASE_URL}/api/upload`, {
                        method: "POST",
                        headers: {
                          Authorization: `Bearer ${localStorage.getItem(
                            "token"
                          )}`,
                        },
                        body: formData,
                      });

                      const data = await response.json();

                      if (response.ok) {
                        const attachmentItem = document.createElement("div");
                        attachmentItem.className = "attachment-item";
                        attachmentItem.innerHTML = `
                  <img src="${
                    data.driveLink
                  }" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                  <input type="hidden" name="attachments[]" 
                         data-type="photo" 
                         data-filename="photo_${Date.now()}.png" 
                         value="${data.driveLink}">
                `;
                        document
                          .getElementById("attachmentsContainer")
                          .appendChild(attachmentItem);
                      }
                    } catch (error) {
                      console.error("Photo upload failed:", error);
                      alert("Photo upload failed");
                    }
                  }, "image/png");

                  // Cleanup
                  stream.getTracks().forEach((track) => track.stop());
                  modal.remove();
                });

              // Cancel handler
              cameraContainer
                .querySelector(".cancel-btn")
                .addEventListener("click", function () {
                  stream.getTracks().forEach((track) => track.stop());
                  modal.remove();
                });
            })
            .catch(function (error) {
              console.error("Camera error:", error);
              modal.remove();
              alert("Could not access camera. Please check permissions.");
            });
        });

      // Styled Reconciliation Editor as a centered popup
      document
        .getElementById("reconcileButton")
        .addEventListener("click", function () {
          // Create modal overlay with improved positioning and styling
          const modal = document.createElement("div");
          modal.style.position = "fixed";
          modal.style.top = "0";
          modal.style.left = "0";
          modal.style.width = "100%";
          modal.style.height = "100%";
          modal.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
          modal.style.display = "flex";
          modal.style.alignItems = "center";
          modal.style.justifyContent = "center";
          modal.style.zIndex = "1000";

          // Reconciliation container with better styling
          const editor = document.createElement("div");
          editor.style.backgroundColor = "white";
          editor.style.borderRadius = "8px";
          editor.style.padding = "20px";
          editor.style.width = "90%";
          editor.style.maxWidth = "700px";
          editor.style.boxShadow = "0 4px 15px rgba(0,0,0,0.2)";

          editor.innerHTML = `
    <h3 style="font-size: 20px; margin-bottom: 15px; font-weight: 600;">Reconciliation Letter</h3>
    <textarea 
        style="width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 4px; min-height: 300px; font-family: Arial, sans-serif; margin-bottom: 15px; resize: vertical;"
        placeholder="Write your reconciliation letter here..."
    ></textarea>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="cancel-btn" style="padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Cancel
        </button>
        <button class="save-btn" style="padding: 8px 16px; background-color: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Save Letter
        </button>
    </div>
  `;

          modal.appendChild(editor);
          document.body.appendChild(modal);

          // Save handler
          editor
            .querySelector(".save-btn")
            .addEventListener("click", async function () {
              const letterContent = editor
                .querySelector("textarea")
                .value.trim();

              if (!letterContent) {
                alert("Please write something in the letter.");
                return;
              }

              try {
                const blob = new Blob([letterContent], { type: "text/plain" });
                const formData = new FormData();
                formData.append(
                  "attachment",
                  blob,
                  `reconciliation_${Date.now()}.txt`
                );

                const response = await fetch(`${BASE_URL}/api/upload`, {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                  body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                  createFileAttachment(
                    `reconciliation_${Date.now()}.txt`,
                    data.driveLink,
                    "reconcile"
                  );
                  modal.remove();
                }
              } catch (error) {
                console.error("Reconciliation upload failed:", error);
                alert("Failed to save reconciliation letter");
              }
            });

          // Cancel handler
          editor
            .querySelector(".cancel-btn")
            .addEventListener("click", function () {
              modal.remove();
            });
        });
      function createAttachmentElement(content, type) {
        const div = document.createElement("div");
        div.className =
          "p-3 border rounded bg-gray-50 flex items-center justify-between";

        if (type === "photo") {
          div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="${content}" class="h-12 w-12 object-cover">
                        <span>Photo</span>
                    </div>
                    <button onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-700">✕</button>
                `;
        } else if (type === "file") {
          div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-2xl"></span>
                        <span>${content.name}</span>
                    </div>
                    <button onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-700">✕</button>
                `;
        } else if (type === "reconciliation") {
          div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-2xl"></span>
                        <div>
                            <p class="font-medium">Reconciliation Letter</p>
                            <p class="text-sm text-gray-600">${content.substring(
                              0,
                              50
                            )}...</p>
                        </div>
                    </div>
                    <button onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-700">✕</button>
                `;
        }
        return div;
      }
      function removeSubCategory(button) {
        button.closest(".subcategory-container").remove();
        updateTotals();
      }

      function updateTotals() {
        const formatter = createCurrencyFormatter();
        let total = 0;
        document.querySelectorAll(".subcategory-container").forEach((box) => {
          box.querySelectorAll("tbody tr").forEach((row) => {
            const amount = parseFloat(row.querySelector(".amount").value) || 0;
            const qty = parseInt(row.querySelector(".quantity").value) || 1;
            total += amount * qty;
          });
        });

        const moneyAtHand =
          parseFloat(document.getElementById("moneyAtHand").value) || 0;
        const transactionCost =
          parseFloat(document.getElementById("transactionCost").value) || 0;
        const totalRequest = total + transactionCost - moneyAtHand;

        document.getElementById("totalRequest").value = formatter.format(
          totalRequest > 0 ? totalRequest : 0
        );
      }
      document.getElementById("proceedButton").style.display = "block";
      function proceed() {
        // Create formatter first, before using it
        const formatter = createCurrencyFormatter();

        let total = 0;
        let summaryHTML = `<h3>Summary</h3>
        <p><strong>Request Type:</strong> ${
          document.getElementById("requestType").value
        }</p>
        <p><strong>Category:</strong> ${
          document.getElementById("category").value
        }</p>`;

        // Get money at hand value
        const moneyAtHand =
          parseFloat(document.getElementById("moneyAtHand").value) || 0;

        // Add money at hand to summary if it exists
        if (moneyAtHand > 0) {
          summaryHTML += `<p>Money at Hand: ${formatter.format(
            moneyAtHand
          )}</p>`;
        }

        // Loop through all subcategories
        document.querySelectorAll(".subcategory-container").forEach((box) => {
          let name = box.querySelector("h2").innerText;
          summaryHTML += `<div class="summary-subcategory"><h4>${name}</h4>`;

          let subCategoryTotal = 0;
          box.querySelectorAll("tbody tr").forEach((row) => {
            let desc = row.querySelector("input[type='text']").value;
            let amount = parseFloat(row.querySelector(".amount").value) || 0;
            let qty = parseInt(row.querySelector(".quantity").value) || 1;
            let subtotal = amount * qty;
            subCategoryTotal += subtotal;

            summaryHTML += `
                <div class="summary-item">
                    <span>${desc}</span>
                    <span>${formatter.format(
                      amount
                    )} x ${qty} = ${formatter.format(subtotal)}</span>
                </div>`;
          });
          total += subCategoryTotal;
          summaryHTML += `</div>`;
        });

        // Get transaction cost (if any)
        const transactionCost =
          parseFloat(document.getElementById("transactionCost").value) || 0;

        // Calculate total request amount (items total + transaction cost)
        const totalRequest = total + transactionCost;

        // Get the currency code for later use
        const currencyCode = getUserCurrency();
        document.getElementById("currencyCode").value = currencyCode;

        // If transaction cost exists, add it to the summary
        if (transactionCost > 0) {
          summaryHTML += `<p>Transaction Cost: ${formatter.format(
            transactionCost
          )}</p>`;
        }

        // Display the total
        summaryHTML += `<p class="total-display">Total Amount: ${formatter.format(
          total
        )}</p>`;
        summaryHTML += `<p class="total-display">Total Request: ${formatter.format(
          totalRequest
        )}</p>`;

        document.getElementById("totalRequest").value =
          formatter.format(totalRequest);

        // Show the summary and the proceed button
        document.getElementById("summary").innerHTML = summaryHTML;
        document.getElementById("summary").classList.remove("hidden");
        document.getElementById("sendReceiptButton").style.display = "block";
      }

      async function sendAndDownloadReceipt() {
        // Show spinner and hide button
        const sendBtn = document.getElementById("sendReceiptButton");
        const feedback = document.getElementById("feedback");
        sendBtn.disabled = true;
        sendBtn.innerHTML = `<span class="spinner"></span> Submitting...`;
        feedback.style.display = "none";

        // Get user data from localStorage
        const user = JSON.parse(localStorage.getItem("user")) || {
          name: "Unknown User",
          email: "unknown@example.com",
          country: "Unknown",
        };

        // Get currency code based on user's country
        const currencyCode = getUserCurrency();

        // Collect form data
        const formData = {
          requestType: document.getElementById("requestType").value,
          category: document.getElementById("category").value,
          moneyAtHand:
            parseFloat(document.getElementById("moneyAtHand").value) || 0,
          transactionCost:
            parseFloat(document.getElementById("transactionCost").value) || 0,
          currencyCode: currencyCode,
          subCategories: [],
        };

        // Collect subcategories and their expense items
        document
          .querySelectorAll(".subcategory-container")
          .forEach((container) => {
            const subCategoryName = container.querySelector("h2").innerText;
            const items = [];
            container.querySelectorAll("tbody tr").forEach((row) => {
              const inputs = row.querySelectorAll("input");
              const description = inputs[0].value;
              const amount = parseFloat(inputs[1].value);
              const quantity = parseInt(inputs[2].value);

              // Only add item if it has a description and valid numbers
              if (
                description &&
                !isNaN(amount) &&
                amount > 0 &&
                !isNaN(quantity) &&
                quantity > 0
              ) {
                items.push({
                  description: description,
                  amount: amount,
                  quantity: quantity,
                });
              }
            });

            if (items.length > 0) {
              formData.subCategories.push({
                name: subCategoryName,
                items: items,
              });
            }
          });

        if (formData.subCategories.length === 0) {
          alert(
            "Please add at least one sub-category with valid expense items."
          );
          sendBtn.disabled = false;
          sendBtn.innerHTML = "Submit Request";
          return;
        }

        // Calculate totals from the structured data
        const totalAmount = formData.subCategories.reduce((sum, subCat) => {
          return (
            sum +
            subCat.items.reduce(
              (subSum, item) => subSum + item.amount * item.quantity,
              0
            )
          );
        }, 0);
        const totalRequest = totalAmount + formData.transactionCost;

        // Process attachments
        formData.attachments = [];
        document.querySelectorAll('[name="attachments[]"]').forEach((input) => {
          if (input.value) {
            formData.attachments.push({
              type: input.dataset.type,
              fileName: input.dataset.filename,
              content: input.value,
            });
          }
        });

        // Send to backend
        try {
          const response = await fetch(`${BASE_URL}/api/requests`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({
              requestType: formData.requestType,
              category: formData.category,
              subCategories: formData.subCategories,
              moneyAtHand: formData.moneyAtHand, // Send the new structured data
              transactionCost: formData.transactionCost,
              attachments: formData.attachments,
            }),
          });

          if (!response.ok)
            throw new Error("Request failed with status: " + response.status);

          const data = await response.json();

          // Generate and download PDF form
          downloadReceipt(user, formData, totalAmount, totalRequest);

          feedback.style.color = "green";
          feedback.innerText = "Request successfully sent!";
        } catch (error) {
          console.error("Submission Error:", error);
          alert(`Submission Failed: ${error.message}`);
          feedback.style.color = "red";
          feedback.innerText = "Request failed. Please try again.";
        } finally {
          sendBtn.innerHTML = `Send and Download Receipt`;
          sendBtn.disabled = false;
          feedback.style.display = "block";

          // Refresh after 1 seconds
          setTimeout(() => location.reload(), 1000);
        }
      }

      function downloadReceipt(user, formData, totalAmount, totalRequest) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const backgroundLogo = new Image();
        backgroundLogo.src = "/receiptlogo.png"; // Path to your logo

        backgroundLogo.onload = () => {
          generatePdf();
        };

        backgroundLogo.onerror = () => {
          console.error(
            "Failed to load background logo. Proceeding without it."
          );
          generatePdf(); // Proceed even if the logo fails to load
        };

        function generatePdf() {
          const pageCount = doc.internal.getNumberOfPages();

          // Add background logo to all pages
          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);

            // Add watermark
            if (backgroundLogo.complete && backgroundLogo.naturalWidth !== 0) {
              const pageWidth = doc.internal.pageSize.getWidth();
              const pageHeight = doc.internal.pageSize.getHeight();
              // Set transparency
              doc.setGState(new doc.GState({ opacity: 0.1 }));
              // Add the image, centered and covering the page
              doc.addImage(
                backgroundLogo,
                "PNG",
                40,
                60,
                pageWidth - 80,
                pageHeight - 120
              );
              // Reset transparency
              doc.setGState(new doc.GState({ opacity: 1 }));
            }
          }

          const currentDate = new Date();
          const dateString = currentDate.toLocaleDateString();

          doc.setFontSize(18);
          doc.setFont("helvetica", "bold");
          doc.text("FH-EXPERIENCE", 105, 20, { align: "center" });
          doc.text("FUND REQUEST FORM", 105, 30, { align: "center" });

          doc.setFontSize(10);
          doc.setFont("helvetica", "normal");
          doc.text(`Date: ${dateString}`, 195, 25, { align: "right" });

          doc.setFontSize(12);
          doc.setFont("helvetica", "bold");
          doc.text("Applicant Details:", 15, 50);
          doc.setFont("helvetica", "normal");
          doc.text(`Name: ${user.name}`, 15, 60);
          doc.text(`Email: ${user.email}`, 15, 70);
          doc.text(`Country: ${user.country}`, 15, 80);

          doc.setFont("helvetica", "bold");
          doc.text("Request Details:", 15, 100);
          doc.setFont("helvetica", "normal");
          doc.text(`Type: ${formData.requestType}`, 15, 110);
          doc.text(`Category: ${formData.category}`, 15, 120);

          doc.setFont("helvetica", "bold");
          doc.text("Expense Items:", 15, 140);

          const headers = [
            ["Sub-category", "Description", "Amount", "Quantity", "Subtotal"],
          ];
          const data = [];
          formData.subCategories.forEach((subCat) => {
            if (subCat.items.length > 0) {
              subCat.items.forEach((item, index) => {
                data.push([
                  index === 0 ? subCat.name : "",
                  item.description,
                  item.amount.toFixed(2),
                  item.quantity,
                  (item.amount * item.quantity).toFixed(2),
                ]);
              });
            }
          });

          doc.autoTable({
            startY: 145,
            head: headers,
            body: data,
            theme: "grid",
            headStyles: { fillColor: [66, 133, 244] },
          });

          const finalY = doc.previousAutoTable.finalY + 10;
          doc.text("Transaction Cost:", 130, finalY);
          doc.text(`${formData.transactionCost.toFixed(2)}`, 180, finalY, {
            align: "right",
          });

          doc.text("Total Amount:", 130, finalY + 10);
          doc.text(`${totalAmount.toFixed(2)}`, 180, finalY + 10, {
            align: "right",
          });

          doc.setFont("helvetica", "bold");
          doc.text("Total Request:", 130, finalY + 20);
          doc.text(`${totalRequest.toFixed(2)}`, 180, finalY + 20, {
            align: "right",
          });

          // Footer text
          doc.setFontSize(8);
          doc.text("Form generated by FHE Funds Management System.", 105, 285, {
            align: "center",
          });
          doc.text(
            "This Form is Electronically Generated - No Signature Required.",
            105,
            290,
            { align: "center" }
          );

          doc.save(`fund_request_form_${Date.now()}.pdf`);
        }
      }
    </script>
  </body>
</html>
