<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta property="og:title" content="Fh260-Africa" />
    <meta
      property="og:description"
      content="Digitalising Fh260-Africa Operations"
    />
    <meta property="og:image" content="https://fh260.org/og-fhlogo.jpeg" />
    <meta property="og:url" content="https://fh260.org" />
    <title>Receipt Portal</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="./css/styles.css" />
    <style>
      /* General Styles */
      body {
        font-family: "Arial", sans-serif;
        background: #f4f4f9;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      main h1 {
        margin: 0;
        font-size: 2.5rem;
        text-align: center;
      }

      main {
        flex: 1;
        padding: 20px;
      }

      #results-section,
      #transfers-section {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-bottom: 30px;
      }

      .container {
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-width: 300px;
        flex: 1 1 300px;
        position: relative;
      }

      .container h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #007bff;
      }

      .container p {
        margin: 5px 0;
        font-size: 0.9rem;
      }

      .clear-btn {
        display: block;
        margin: 10px 0;
        padding: 10px;
        font-size: 0.9rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 8cm;
        height: 1cm;
        background: red;
        color: white;
      }

      .extra-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        gap: 10px;
        display: none; /* Hidden initially */
      }

      .extra-buttons button {
        width: 2cm;
        height: 1cm;
        padding: 5px;
        font-size: 0.9rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .photo-btn {
        background: blue;
        color: white;
      }

      .upload-btn {
        background: green;
        color: white;
      }

      .reconcile-btn {
        background: orange;
        color: white;
      }

      .submit-btn {
        background: yellow;
        color: black;
        display: none;
        margin-top: 10px;
        padding: 10px;
        font-size: 0.9rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 8cm;
        height: 1cm;
      }

      .submit-btn:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
      }

      .reconcile-area {
        display: none;
        margin-top: 10px;
        width: 100%;
      }

      .receipt-input {
        width: 100%;
        padding: 8px;
        margin-top: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .receipt-input.error {
        border-color: #ff0000;
      }

      .error-message {
        color: #ff0000;
        font-size: 0.8rem;
        margin: 5px 0;
        display: block;
      }

      #name-dropdown {
        height: 1cm;
        font-size: 16px;
        padding: 5px;
        border: 2px solid #333;
        border-radius: 5px;
      }
      .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #000;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
      }

      /* Section headers */
      .section-header {
        width: 100%;
        text-align: center;
        margin: 20px 0 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #007bff;
        color: #007bff;
      }

      /* Dark Mode Styles */
      .dark-mode {
        background-color: #121212;
        color: #e0e0e0;
      }

      .dark-mode main {
        background-color: #121212;
      }

      .dark-mode h1 {
        color: #4fc3f7;
      }

      .dark-mode .container {
        background-color: #1e1e1e;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .dark-mode .container h3 {
        color: #4fc3f7;
      }

      .dark-mode .container p {
        color: #e0e0e0;
      }

      .dark-mode .clear-btn {
        background-color: #d32f2f;
        color: white;
      }

      .dark-mode .photo-btn {
        background-color: #1565c0;
        color: white;
      }

      .dark-mode .upload-btn {
        background-color: #2e7d32;
        color: white;
      }

      .dark-mode .reconcile-btn {
        background-color: #ef6c00;
        color: white;
      }

      .dark-mode .submit-btn {
        background-color: #ffd600;
        color: #121212;
      }

      .dark-mode .submit-btn:disabled {
        background-color: #555;
        color: #999;
      }

      .dark-mode .receipt-input,
      .dark-mode .reconcile-area {
        background-color: #2d2d2d;
        color: #e0e0e0;
        border-color: #444;
      }

      .dark-mode .receipt-input.error {
        border-color: #ff4444;
      }

      .dark-mode .file-display {
        color: #81c784 !important;
      }

      .dark-mode footer {
        background-color: #1e1e1e;
        color: #e0e0e0;
      }

      .dark-mode footer a {
        color: #e0e0e0;
      }

      .dark-mode footer a:hover {
        color: #81d4fa;
      }

      .dark-mode .section-header {
        color: #4fc3f7;
        border-bottom-color: #4fc3f7;
      }

      /* Modal dark mode */
      .dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #e0e0e0;
      }

      .dark-mode .profile-dropdown {
        background-color: #2d2d2d;
        border-color: #444;
      }

      .dark-mode .profile-dropdown a {
        color: #e0e0e0;
      }

      .dark-mode .profile-dropdown a:hover {
        background-color: #3d3d3d;
      }

      /* Loading spinner in dark mode */
      .dark-mode .loading-spinner {
        border-left-color: #e0e0e0;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <header class="top-nav">
      <div class="logo">
        <img
          src="logoR.png"
          alt="Fh260 Logo"
          style="height: 30px; margin-right: 15px"
        />
        <h1>Fh260</h1>
      </div>

      <!-- Desktop Navigation -->
      <nav class="desktop-nav">
        <a href="home.html">Home</a>
        <a href="apply.html">Apply</a>
        <a href="downloads.html">Downloads</a>
        <a href="receipts.html" class="active">Receipts</a>
        <a href="Task.html">Reminder</a>
        <a href="fundsTransfer.html">Transfer</a>
      </nav>

      <!-- Desktop User Profile (visible on desktop only) -->
      <div class="user-profile">
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user"></i>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
          <a href="#" id="viewProfileBtn"
            ><i class="fas fa-edit"></i> View/Edit Profile</a
          >
          <a href="#" id="logoutBtn"
            ><i class="fas fa-sign-out-alt"></i> Logout</a
          >
        </div>
      </div>

      <!-- Mobile Controls Container (groups user profile and hamburger on mobile) -->
      <div class="mobile-controls">
        <div class="user-profile">
          <div class="user-icon" id="userIconMobile">
            <i class="fas fa-user"></i>
          </div>
          <div class="profile-dropdown" id="profileDropdownMobile">
            <a href="#" id="viewProfileBtnMobile"
              ><i class="fas fa-edit"></i> View/Edit Profile</a
            >
            <a href="#" id="logoutBtnMobile"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </div>
        </div>

        <!-- Hamburger Menu Button -->
        <div class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <!-- Mobile Navigation Menu -->
      <nav id="nav-menu">
        <div class="close-nav" id="close-nav">
          <i class="fas fa-times"></i>
        </div>
        <a href="home.html">Home</a>
        <a href="apply.html">Apply</a>
        <a href="downloads.html">Downloads</a>
        <a href="receipts.html" class="active">Receipts</a>
        <a href="Task.html">Reminder</a>
        <a href="fundsTransfer.html">Transfer</a>
      </nav>
    </header>
    <main>
      <h1>Receipt Portal</h1>
      <p>
        These are the expenses on your name/your colleague's name that await
        receipts. Please click on each to upload.
      </p>
      <section id="user-switch-section">
        <label for="user-selector">Clear Receipts For:</label>
        <select id="user-selector"></select>
      </section>

      <h2 class="section-header">Pending Receipts</h2>
      <section id="results-section">
        <!-- Receipt containers will be dynamically added here -->
      </section>

      <h2 class="section-header">Uncleared Transfers</h2>
      <section id="transfers-section">
        <!-- Transfer containers will be dynamically added here -->
      </section>
    </main>

    <div id="profileModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h3>Edit Profile</h3>
        <div class="profile-picture">
          <img
            id="profileImage"
            src="https://via.placeholder.com/80"
            alt="Profile"
            class="initials-circle"
          />
          <input
            type="file"
            id="profileUpload"
            style="display: none"
            accept="image/*"
          />
          <button class="upload-btn" id="uploadBtn">
            <i class="fas fa-upload"></i> Upload
          </button>
        </div>
        <form id="profileForm">
          <div class="form-group">
            <label for="fullName">Full Name</label>
            <input type="text" id="fullName" readonly />
          </div>
          <div class="form-group">
            <label for="role">Role</label>
            <input type="text" id="role" placeholder="Enter your role" />
          </div>
          <div class="form-group">
            <label for="bio">Bio/Short Description</label>
            <textarea
              id="bio"
              placeholder="Tell us about yourself..."
            ></textarea>
          </div>
          <div class="form-group theme-switcher">
            <label>Theme</label>
            <i class="fas fa-sun" id="themeIcon"></i>
          </div>
          <div class="modal-buttons">
            <button type="submit" class="save-btn">Save Changes</button>
            <button type="button" class="cancel-btn" id="cancelBtn">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
    <footer>
      <p>&copy; 2025 Fh260. All rights reserved.</p>
      <div class="footer-links">
        <a href="sign.html">Sign In</a> | <a href="index.html">Back Page</a> |
        <a href="admin.html">Admin</a>
      </div>
    </footer>
    <script src="js/global-nav.js"></script>
    <script src="js/profile-handler.js"></script>
    <script>
      // Base URL
      const BASE_URL = "http://localhost:3000";

      // Format currency function
      function formatCurrency(amount, currencyCode) {
        const code = currencyCode || "USD";
        return new Intl.NumberFormat(undefined, {
          style: "currency",
          currency: code,
          minimumFractionDigits: 2,
        }).format(parseFloat(amount));
      }

      // Validation function for receipts
      function validateReceiptForm(
        receiptInput,
        uploadedFile,
        reconcileArea,
        remainingBalance
      ) {
        const errors = [];
        const amount = parseFloat(receiptInput.value);

        if (!receiptInput.value.trim() || isNaN(amount) || amount <= 0) {
          errors.push("Please enter a valid amount to clear");
        }

        if (amount > remainingBalance) {
          errors.push(
            `Amount cannot exceed remaining balance of ${formatCurrency(
              remainingBalance,
              "USD"
            )}`
          );
        }

        if (!uploadedFile && !reconcileArea.value.trim()) {
          errors.push(
            "Please upload a receipt/photo or provide reconciliation notes"
          );
        }

        return errors;
      }

      // Validation function for transfers
      function validateTransferForm(
        transferInput,
        uploadedFile,
        reconcileArea,
        transferAmount
      ) {
        const errors = [];
        const amount = parseFloat(transferInput.value);

        if (!transferInput.value.trim() || isNaN(amount) || amount <= 0) {
          errors.push("Please enter a valid amount to clear");
        }

        if (amount !== parseFloat(transferAmount)) {
          errors.push(
            `Amount must be exactly ${formatCurrency(transferAmount, "USD")}`
          );
        }

        if (!uploadedFile && !reconcileArea.value.trim()) {
          errors.push(
            "Please upload a receipt/photo or provide reconciliation notes"
          );
        }

        return errors;
      }

      // Function to display validation errors
      function displayErrors(container, errors) {
        const existingErrors = container.querySelectorAll(".error-message");
        existingErrors.forEach((error) => error.remove());

        errors.forEach((error) => {
          const errorElement = document.createElement("div");
          errorElement.className = "error-message";
          errorElement.textContent = error;
          container.appendChild(errorElement);
        });
      }

      // Fetch pending receipts for a user
      async function fetchReceiptsFor(userId) {
        const token = localStorage.getItem("token");
        const res = await fetch(
          `${BASE_URL}/api/receipts/pending?userId=${userId}`,
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        const receipts = await res.json();

        const resultsSection = document.getElementById("results-section");
        resultsSection.innerHTML = "";

        receipts.forEach((receipt) => {
          const container = document.createElement("div");
          container.className = "container";
          const balanceColor = receipt.balance > 0 ? "red" : "green";
          const remainingBalance = parseFloat(receipt.balance);

          const formattedAmount = formatCurrency(
            receipt.amount,
            receipt.currency_code
          );
          const formattedBalance = formatCurrency(
            receipt.balance,
            receipt.currency_code
          );

          container.innerHTML = `
            <h3>Reference: ${receipt.reference}</h3>
            <p><strong>Category:</strong> ${receipt.category || "N/A"}</p>
            <p><strong>Total Amount:</strong> ${formattedAmount}</p>
            <p><strong>Remaining Balance:</strong> <span style="color: ${balanceColor}">${formattedBalance}</span></p>
            <p><strong>Date:</strong> ${new Date(
              receipt.submission_time
            ).toLocaleString()}</p>
            <button class="clear-btn">Clear</button>
            <div class="extra-buttons" style="display: none;">
              <button class="photo-btn">Take Photo</button>
              <button class="upload-btn">Upload File</button>
              <button class="reconcile-btn">Write Reconcile</button>
            </div>
            <input type="number" class="receipt-input" placeholder="Enter amount to clear (max: ${
              receipt.balance
            })" 
                   style="display: none;" step="0.01" min="0.01" max="${
                     receipt.balance
                   }" />
            <textarea class="reconcile-area" rows="4" style="display: none;" placeholder="Reconciliation notes (optional)"></textarea>
            <p class="file-display" style="display: none;"></p>
            <button class="submit-btn" style="display: none;" disabled>Submit to Clear</button>
          `;

          const clearBtn = container.querySelector(".clear-btn");
          const extraButtons = container.querySelector(".extra-buttons");
          const photoBtn = container.querySelector(".photo-btn");
          const uploadBtn = container.querySelector(".upload-btn");
          const reconcileBtn = container.querySelector(".reconcile-btn");
          const receiptInput = container.querySelector(".receipt-input");
          const reconcileArea = container.querySelector(".reconcile-area");
          const submitBtn = container.querySelector(".submit-btn");
          const fileDisplay = container.querySelector(".file-display");

          let uploadedFile = null;

          function validateAndToggleSubmit() {
            const errors = validateReceiptForm(
              receiptInput,
              uploadedFile,
              reconcileArea,
              remainingBalance
            );

            if (errors.length === 0) {
              submitBtn.disabled = false;
              receiptInput.classList.remove("error");
              const existingErrors =
                container.querySelectorAll(".error-message");
              existingErrors.forEach((error) => error.remove());
            } else {
              submitBtn.disabled = true;
              receiptInput.classList.add("error");
              displayErrors(container, errors);
            }
          }

          clearBtn.addEventListener("click", () => {
            clearBtn.style.display = "none";
            extraButtons.style.display = "flex";
            receiptInput.style.display = "block";
            submitBtn.style.display = "block";
          });

          receiptInput.addEventListener("input", validateAndToggleSubmit);
          reconcileArea.addEventListener("input", validateAndToggleSubmit);

          function handleFileUpload(file) {
            uploadedFile = file;
            fileDisplay.style.display = "block";
            fileDisplay.textContent = `Selected: ${file.name}`;
            validateAndToggleSubmit();
          }

          photoBtn.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.setAttribute("accept", "image/*");
            input.setAttribute("capture", "environment");
            input.style.display = "none";
            document.body.appendChild(input);
            input.click();
            input.addEventListener("change", () => {
              if (input.files.length > 0) {
                handleFileUpload(input.files[0]);
              }
              document.body.removeChild(input);
            });
          });

          uploadBtn.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.style.display = "none";
            document.body.appendChild(input);
            input.click();
            input.addEventListener("change", () => {
              if (input.files.length > 0) {
                handleFileUpload(input.files[0]);
              }
              document.body.removeChild(input);
            });
          });

          reconcileBtn.addEventListener("click", () => {
            reconcileArea.style.display = "block";
            validateAndToggleSubmit();
          });

          submitBtn.addEventListener("click", async () => {
            const amount = parseFloat(receiptInput.value);

            const errors = validateReceiptForm(
              receiptInput,
              uploadedFile,
              reconcileArea,
              remainingBalance
            );
            if (errors.length > 0) {
              displayErrors(container, errors);
              return;
            }

            const spinner = document.createElement("span");
            spinner.className = "loading-spinner";
            submitBtn.appendChild(spinner);
            submitBtn.disabled = true;

            let driveLink = null;
            let fileType = null;
            let fileName = null;

            try {
              if (uploadedFile) {
                const formData = new FormData();
                formData.append("attachment", uploadedFile);
                const uploadRes = await fetch(`${BASE_URL}/api/upload`, {
                  method: "POST",
                  headers: { Authorization: `Bearer ${token}` },
                  body: formData,
                });
                const uploadData = await uploadRes.json();
                driveLink = uploadData.driveLink;
                fileType = "receipt";
                fileName = uploadedFile.name;
              } else if (reconcileArea.value.trim()) {
                const blob = new Blob([reconcileArea.value.trim()], {
                  type: "text/plain",
                });
                const file = new File([blob], `reconcile_${Date.now()}.txt`, {
                  type: "text/plain",
                });

                const formData = new FormData();
                formData.append("attachment", file);
                const uploadRes = await fetch(`${BASE_URL}/api/upload`, {
                  method: "POST",
                  headers: { Authorization: `Bearer ${token}` },
                  body: formData,
                });
                const uploadData = await uploadRes.json();
                driveLink = uploadData.driveLink;
                fileType = "reconcile";
                fileName = file.name;
              }

              const clearRes = await fetch(`${BASE_URL}/api/receipts/clear`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  reference: receipt.reference,
                  amount,
                  driveLink,
                  fileType,
                  fileName,
                }),
              });

              const result = await clearRes.json();
              alert(result.message);
            } catch (error) {
              console.error("Clearance error:", error);
              alert("Clearance failed: " + error.message);
            } finally {
              if (submitBtn.contains(spinner)) {
                submitBtn.removeChild(spinner);
              }
              fetchReceiptsFor(userId);
            }
          });

          resultsSection.appendChild(container);
        });
      }

      // Fetch uncleared transfers for a user
      async function fetchTransfersFor(userId) {
        const token = localStorage.getItem("token");
        const res = await fetch(
          `${BASE_URL}/api/transfers/uncleared?userId=${userId}`,
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        const transfers = await res.json();

        const transfersSection = document.getElementById("transfers-section");
        transfersSection.innerHTML = "";

        transfers.forEach((transfer) => {
          const container = document.createElement("div");
          container.className = "container";
          const transferAmount = parseFloat(transfer.total_amount);

          const formattedAmount = formatCurrency(
            transfer.total_amount,
            transfer.currency_code
          );

          container.innerHTML = `
            <h3>Transfer Reference: ${transfer.id}</h3>
            <p><strong>Receipt Reference:</strong> ${
              transfer.receipts_table_request_type_id
            }</p>
            <p><strong>Transfer Category:</strong> ${transfer.category}</p>
            <p><strong>Transfer Date:</strong> ${new Date(
              transfer.created_at
            ).toLocaleString()}</p>
            <p><strong>Transfer Amount:</strong> ${formattedAmount}</p>
            <button class="clear-btn">Clear Transfer</button>
            <div class="extra-buttons" style="display: none;">
              <button class="photo-btn">Take Photo</button>
              <button class="upload-btn">Upload File</button>
              <button class="reconcile-btn">Write Reconcile</button>
            </div>
            <input type="number" class="receipt-input" placeholder="Enter amount to clear (must be: ${
              transfer.total_amount
            })" 
                   style="display: none;" step="0.01" value="${
                     transfer.total_amount
                   }" readonly />
            <textarea class="reconcile-area" rows="4" style="display: none;" placeholder="Reconciliation notes (optional)"></textarea>
            <p class="file-display" style="display: none;"></p>
            <button class="submit-btn" style="display: none;" disabled>Submit to Clear</button>
          `;

          const clearBtn = container.querySelector(".clear-btn");
          const extraButtons = container.querySelector(".extra-buttons");
          const photoBtn = container.querySelector(".photo-btn");
          const uploadBtn = container.querySelector(".upload-btn");
          const reconcileBtn = container.querySelector(".reconcile-btn");
          const receiptInput = container.querySelector(".receipt-input");
          const reconcileArea = container.querySelector(".reconcile-area");
          const submitBtn = container.querySelector(".submit-btn");
          const fileDisplay = container.querySelector(".file-display");

          let uploadedFile = null;

          function validateAndToggleSubmit() {
            const errors = validateTransferForm(
              receiptInput,
              uploadedFile,
              reconcileArea,
              transferAmount
            );

            if (errors.length === 0) {
              submitBtn.disabled = false;
              receiptInput.classList.remove("error");
              const existingErrors =
                container.querySelectorAll(".error-message");
              existingErrors.forEach((error) => error.remove());
            } else {
              submitBtn.disabled = true;
              receiptInput.classList.add("error");
              displayErrors(container, errors);
            }
          }

          clearBtn.addEventListener("click", () => {
            clearBtn.style.display = "none";
            extraButtons.style.display = "flex";
            receiptInput.style.display = "block";
            submitBtn.style.display = "block";
          });

          reconcileArea.addEventListener("input", validateAndToggleSubmit);

          function handleFileUpload(file) {
            uploadedFile = file;
            fileDisplay.style.display = "block";
            fileDisplay.textContent = `Selected: ${file.name}`;
            validateAndToggleSubmit();
          }

          photoBtn.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.setAttribute("accept", "image/*");
            input.setAttribute("capture", "environment");
            input.style.display = "none";
            document.body.appendChild(input);
            input.click();
            input.addEventListener("change", () => {
              if (input.files.length > 0) {
                handleFileUpload(input.files[0]);
              }
              document.body.removeChild(input);
            });
          });

          uploadBtn.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.style.display = "none";
            document.body.appendChild(input);
            input.click();
            input.addEventListener("change", () => {
              if (input.files.length > 0) {
                handleFileUpload(input.files[0]);
              }
              document.body.removeChild(input);
            });
          });

          reconcileBtn.addEventListener("click", () => {
            reconcileArea.style.display = "block";
            validateAndToggleSubmit();
          });

          submitBtn.addEventListener("click", async () => {
            const amount = parseFloat(receiptInput.value);

            const errors = validateTransferForm(
              receiptInput,
              uploadedFile,
              reconcileArea,
              transferAmount
            );
            if (errors.length > 0) {
              displayErrors(container, errors);
              return;
            }

            const spinner = document.createElement("span");
            spinner.className = "loading-spinner";
            submitBtn.appendChild(spinner);
            submitBtn.disabled = true;

            let driveLink = null;
            let fileType = null;
            let fileName = null;

            try {
              if (uploadedFile) {
                const formData = new FormData();
                formData.append("attachment", uploadedFile);
                const uploadRes = await fetch(`${BASE_URL}/api/upload`, {
                  method: "POST",
                  headers: { Authorization: `Bearer ${token}` },
                  body: formData,
                });
                const uploadData = await uploadRes.json();
                driveLink = uploadData.driveLink;
                fileType = "receipt";
                fileName = uploadedFile.name;
              } else if (reconcileArea.value.trim()) {
                const blob = new Blob([reconcileArea.value.trim()], {
                  type: "text/plain",
                });
                const file = new File([blob], `reconcile_${Date.now()}.txt`, {
                  type: "text/plain",
                });

                const formData = new FormData();
                formData.append("attachment", file);
                const uploadRes = await fetch(`${BASE_URL}/api/upload`, {
                  method: "POST",
                  headers: { Authorization: `Bearer ${token}` },
                  body: formData,
                });
                const uploadData = await uploadRes.json();
                driveLink = uploadData.driveLink;
                fileType = "reconcile";
                fileName = file.name;
              }

              const clearRes = await fetch(`${BASE_URL}/api/transfers/clear`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  transferId: transfer.id,
                  amount,
                  driveLink,
                  fileType,
                  fileName,
                }),
              });

              const result = await clearRes.json();
              alert(result.message);
            } catch (error) {
              console.error("Transfer clearance error:", error);
              alert("Transfer clearance failed: " + error.message);
            } finally {
              if (submitBtn.contains(spinner)) {
                submitBtn.removeChild(spinner);
              }
              fetchTransfersFor(userId);
            }
          });

          transfersSection.appendChild(container);
        });
      }

      // Load user options for dropdown
      async function loadUserOptions() {
        const token = localStorage.getItem("token");
        const currentUser = JSON.parse(localStorage.getItem("user"));
        const selector = document.getElementById("user-selector");

        const res = await fetch(`${BASE_URL}/api/users/same-country`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const users = await res.json();

        users.forEach((user) => {
          const opt = document.createElement("option");
          opt.value = user.Id;
          opt.textContent = user.name;
          selector.appendChild(opt);
        });

        selector.value = currentUser.Id;

        selector.addEventListener("change", () => {
          const selectedUserId = selector.value;
          fetchReceiptsFor(selectedUserId);
          fetchTransfersFor(selectedUserId);
        });

        // Initial fetch for both receipts and transfers
        fetchReceiptsFor(selector.value);
        fetchTransfersFor(selector.value);
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        if (savedTheme === "dark") {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }

        loadUserOptions();
      });
    </script>
  </body>
</html>
