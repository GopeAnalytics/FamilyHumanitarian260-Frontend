<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta property="og:title" content="Fh260-Africa" />
    <meta
      property="og:description"
      content="Digitalising Fh260-Africa Operations"
    />
    <meta property="og:image" content="https://fh260.org/og-fhlogo.jpeg" />
    <meta property="og:url" content="https://fh260.org" />
    <title>Receipt Portal</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <style>
      /* General Styles */
      body {
        font-family: "Arial", sans-serif;
        background: #f4f4f9;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      header {
        background: #007bff;
        color: white;
        padding: 20px;
        text-align: center;
      }

      header h1 {
        margin: 0;
        font-size: 2.5rem;
      }

      header p {
        margin: 5px 0 0;
        font-size: 1rem;
      }

      nav {
        background-color: #004080;
        color: white;
        text-align: right;
        padding: 10px 0 10px 15px;
      }

      nav a {
        color: white;
        font-size: 1rem;
        margin: 0 15px;
        text-decoration: none;
        font-weight: bold;
      }

      nav a:hover {
        text-decoration: underline;
      }

      main {
        flex: 1;
        padding: 20px;
      }

      #results-section {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }

      .container {
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-width: 300px;
        flex: 1 1 300px;
        position: relative;
      }

      .container h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #007bff;
      }

      .container p {
        margin: 5px 0;
        font-size: 0.9rem;
      }

      .clear-btn {
        display: block;
        margin: 10px 0;
        padding: 10px;
        font-size: 0.9rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 8cm;
        height: 1cm;
        background: red;
        color: white;
      }

      .extra-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        gap: 10px;
        display: none; /* Hidden initially */
      }

      .extra-buttons button {
        width: 2cm;
        height: 1cm;
        padding: 5px;
        font-size: 0.9rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .photo-btn {
        background: blue;
        color: white;
      }

      .upload-btn {
        background: green;
        color: white;
      }

      .reconcile-btn {
        background: orange;
        color: white;
      }

      .submit-btn {
        background: yellow;
        color: black;
        display: none;
        margin-top: 10px;
        padding: 10px;
        font-size: 0.9rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 8cm;
        height: 1cm;
      }

      .reconcile-area {
        display: none;
        margin-top: 10px;
        width: 100%;
      }

      footer {
        background-color: #003366;
        color: white;
        text-align: center;
        padding: 20px 10px;
        margin-top: auto;
      }

      footer a {
        color: #ffcc00;
        text-decoration: none;
        font-weight: bold;
      }

      footer a:hover {
        text-decoration: underline;
      }
      #name-dropdown {
        height: 1cm; /* Set the height to 2 cm */
        font-size: 16px; /* Adjust the font size */
        padding: 5px; /* Add some padding for better appearance */
        border: 2px solid #333; /* Optional border styling */
        border-radius: 5px; /* Optional rounded corners */
      }
      .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #000;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Receipt Portal</h1>
      <p>Select your name and view your balances and transactions.</p>
    </header>
    <nav>
      <a href="home.html">Home</a>
      <a href="downloads.html">Downloads</a>
      <a href="apply.html">Apply</a>
    </nav>
    <main>
      <p>
        These are the expenses on your name that await receipts. Please click on
        each to upload.
      </p>
      <section id="user-switch-section">
        <label for="user-selector">Clear Receipts For:</label>
        <select id="user-selector"></select>
      </section>

      <section id="results-section">
        <!-- Data containers will be dynamically added here -->
      </section>
    </main>
    <footer>
      <p>&copy; 2025 Fh260. All rights reserved.</p>
      <p>
        <a href="sign.html">Sign In</a> | <a href="index.html">Back Page</a> |
        <a href="admin.html">Admin</a>
      </p>
    </footer>
    <script>
      function formatCurrency(amount, currencyCode) {
        // Default to USD if no currency code is provided
        const code = currencyCode || "USD";

        // Create a formatter for the specific currency
        return new Intl.NumberFormat(undefined, {
          style: "currency",
          currency: code,
          minimumFractionDigits: 2,
        }).format(parseFloat(amount));
      }

      async function fetchReceiptsFor(userId) {
        const token = localStorage.getItem("token");
        const res = await fetch(
          `http://localhost:3000/api/receipts/pending?userId=${userId}`,
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        const receipts = await res.json();

        const resultsSection = document.getElementById("results-section");
        resultsSection.innerHTML = "";

        receipts.forEach((receipt) => {
          const container = document.createElement("div");
          container.className = "container";
          const balanceColor = receipt.balance > 0 ? "red" : "green";

          // Format amounts using the currency code
          const formattedAmount = formatCurrency(
            receipt.amount,
            receipt.currency_code
          );
          const formattedBalance = formatCurrency(
            receipt.balance,
            receipt.currency_code
          );

          container.innerHTML = `
        <h3>Reference: ${receipt.reference}</h3>
        <p><strong>Total Amount:</strong> ${formattedAmount}</p>
        <p><strong>Remaining Balance:</strong> <span style="color: ${balanceColor}">${formattedBalance}</span></p>
        <p><strong>Date:</strong> ${new Date(
          receipt.submission_time
        ).toLocaleString()}</p>
        <button class="clear-btn">Clear</button>
        <div class="extra-buttons" style="display: none;">
          <button class="photo-btn">Take Photo</button>
          <button class="upload-btn">Upload File</button>
          <button class="reconcile-btn">Write Reconcile</button>
        </div>
        <input type="number" class="receipt-input" placeholder="Enter receipt amount" style="display: none;" />
        <textarea class="reconcile-area" rows="4" style="display: none;" placeholder="Reconciliation notes (optional)"></textarea>
        <p class="file-display" style="display: none;"></p>
        <button class="submit-btn" style="display: none;">Submit to Clear</button>
      `;

          const clearBtn = container.querySelector(".clear-btn");
          const extraButtons = container.querySelector(".extra-buttons");
          const photoBtn = container.querySelector(".photo-btn");
          const uploadBtn = container.querySelector(".upload-btn");
          const reconcileBtn = container.querySelector(".reconcile-btn");
          const receiptInput = container.querySelector(".receipt-input");
          const reconcileArea = container.querySelector(".reconcile-area");
          const submitBtn = container.querySelector(".submit-btn");
          const fileDisplay = container.querySelector(".file-display");

          clearBtn.addEventListener("click", () => {
            clearBtn.style.display = "none";
            extraButtons.style.display = "flex";
            receiptInput.style.display = "block";
            submitBtn.style.display = "block";
          });

          let uploadedFile = null;

          function handleFileUpload(file) {
            uploadedFile = file;
            fileDisplay.style.display = "block";
            fileDisplay.textContent = `Selected: ${file.name}`;
          }

          photoBtn.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.setAttribute("accept", "image/*");
            input.setAttribute("capture", "environment");
            input.style.display = "none";
            document.body.appendChild(input);
            input.click();
            input.addEventListener("change", () => {
              if (input.files.length > 0) {
                handleFileUpload(input.files[0]);
              }
              document.body.removeChild(input);
            });
          });

          uploadBtn.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.style.display = "none";
            document.body.appendChild(input);
            input.click();
            input.addEventListener("change", () => {
              if (input.files.length > 0) {
                handleFileUpload(input.files[0]);
              }
              document.body.removeChild(input);
            });
          });

          reconcileBtn.addEventListener("click", () => {
            reconcileArea.style.display = "block";
          });
          submitBtn.addEventListener("click", async () => {
            const amount = parseFloat(receiptInput.value);
            if (!uploadedFile && !reconcileArea.value.trim()) {
              return alert(
                "Please upload a file/photo or enter a reconcile note."
              );
            }

            const spinner = document.createElement("span");
            spinner.className = "loading-spinner";
            submitBtn.appendChild(spinner);

            let driveLink = null;
            let fileType = null;
            let fileName = null;

            try {
              // Upload receipt file
              if (uploadedFile) {
                const formData = new FormData();
                formData.append("attachment", uploadedFile);
                const uploadRes = await fetch(
                  "http://localhost:3000/api/upload",
                  {
                    method: "POST",
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData,
                  }
                );
                const uploadData = await uploadRes.json();
                driveLink = uploadData.driveLink;
                fileType = "receipt";
                fileName = uploadedFile.name;
              }
              // Upload reconcile note
              else if (reconcileArea.value.trim()) {
                const blob = new Blob([reconcileArea.value.trim()], {
                  type: "text/plain",
                });
                const file = new File([blob], `reconcile_${Date.now()}.txt`, {
                  type: "text/plain",
                });

                const formData = new FormData();
                formData.append("attachment", file);
                const uploadRes = await fetch(
                  "http://localhost:3000/api/upload",
                  {
                    method: "POST",
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData,
                  }
                );
                const uploadData = await uploadRes.json();
                driveLink = uploadData.driveLink;
                fileType = "reconcile";
                fileName = file.name;
              }

              // Send clearance request
              const clearRes = await fetch(
                "http://localhost:3000/api/receipts/clear",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify({
                    reference: receipt.reference,
                    amount,
                    driveLink,
                    fileType,
                    fileName,
                  }),
                }
              );

              const result = await clearRes.json();
              alert(result.message);
            } catch (error) {
              console.error("Clearance error:", error);
              alert("Clearance failed.");
            } finally {
              submitBtn.removeChild(spinner);
              fetchReceiptsFor(userId); // Refresh list
            }
          });

          resultsSection.appendChild(container);
        });
      }

      async function loadUserOptions() {
        const token = localStorage.getItem("token");
        const currentUser = JSON.parse(localStorage.getItem("user"));
        const selector = document.getElementById("user-selector");

        // Fetch users from same country
        const res = await fetch(
          "http://localhost:3000/api/users/same-country",
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        const users = await res.json();

        // Populate dropdown
        users.forEach((user) => {
          const opt = document.createElement("option");
          opt.value = user.Id;
          opt.textContent = user.name;
          selector.appendChild(opt);
        });

        // Set current user as default
        selector.value = currentUser.Id;

        // Listen for change and fetch relevant receipts
        selector.addEventListener("change", () => {
          fetchReceiptsFor(selector.value);
        });

        // Initial fetch
        fetchReceiptsFor(selector.value);
      }

      // Call the function to initialize the dropdown and data
      loadUserOptions();

      function populateDropdown(data) {
        const uniqueNames = [...new Set(data.map((item) => item.Name))];
        uniqueNames.forEach((name) => {
          if (name) {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            nameDropdown.appendChild(option);
          }
        });
      }

      function setupDropdownListener(data) {
        nameDropdown.addEventListener("change", () => {
          const selectedName = nameDropdown.value;
          resultsSection.innerHTML = "";

          const filteredData = data.filter((row) => row.Name === selectedName);

          filteredData.forEach((row) => {
            const container = document.createElement("div");
            container.classList.add("container");

            // Format amounts with currency if available
            const formattedAmount = row.currencyCode
              ? formatCurrency(row.TotalAmount, row.currencyCode)
              : row.TotalAmount;

            container.innerHTML = `
                          <h3>${row.Name}</h3>
                          <p><strong>Date:</strong> ${row.Date}</p>
                          <p><strong>Total Amount:</strong> ${formattedAmount}</p>
                          <p><strong>Reference:</strong> ${row.Reference}</p>
                          <button class="clear-btn">Clear</button>
                          <div class="extra-buttons" style="display: none;">
                              <button class="photo-btn">Add Photo</button>
                              <button class="upload-btn">Upload File</button>
                              <button class="reconcile-btn">Reconcile</button>
                          </div>
                          <input type="number" class="receipt-input" placeholder="Enter receipt amount" style="display: none; width: 100%; margin-top: 10px;">
                          <textarea class="reconcile-area" rows="4" cols="30" style="display: none;" placeholder="Enter reconciliation details (optional)"></textarea>
                          <p class="file-display" style="display: none; font-size: 0.9rem; color: green;"></p>
                          <button class="submit-btn" style="display: none;">Submit to Clear</button>
                      `;

            const clearBtn = container.querySelector(".clear-btn");
            const extraButtons = container.querySelector(".extra-buttons");
            const photoBtn = container.querySelector(".photo-btn");
            const uploadBtn = container.querySelector(".upload-btn");
            const reconcileBtn = container.querySelector(".reconcile-btn");
            const receiptInput = container.querySelector(".receipt-input");
            const reconcileArea = container.querySelector(".reconcile-area");
            const fileDisplay = container.querySelector(".file-display");
            const submitBtn = container.querySelector(".submit-btn");

            clearBtn.addEventListener("click", () => {
              clearBtn.style.display = "none";
              extraButtons.style.display = "flex";
              receiptInput.style.display = "block";
              submitBtn.style.display = "block";
            });

            photoBtn.addEventListener("click", () => {
              const input = document.createElement("input");
              input.type = "file";
              input.accept = "image/*";
              input.capture = "camera";
              input.style.display = "none"; // Hide the input element
              document.body.appendChild(input);
              input.click();

              input.addEventListener("change", () => {
                if (input.files.length > 0) {
                  const fileParagraph = document.createElement("p");
                  fileParagraph.textContent = `Photo Added: ${input.files[0].name}`;
                  fileParagraph.style.cssText = `
                  font-size: 0.9rem;
                  color: green;
                  margin-top: 5px;
              `;
                  container.appendChild(fileParagraph);
                }
                document.body.removeChild(input);
              });
            });

            uploadBtn.addEventListener("click", () => {
              const input = document.createElement("input");
              input.type = "file";
              input.style.display = "none"; // Hide the input element
              document.body.appendChild(input);
              input.click();

              input.addEventListener("change", () => {
                if (input.files.length > 0) {
                  const fileParagraph = document.createElement("p");
                  fileParagraph.textContent = `File Uploaded: ${input.files[0].name}`;
                  fileParagraph.style.cssText = `
                  font-size: 0.9rem;
                  color: green;
                  margin-top: 5px;
              `;
                  container.appendChild(fileParagraph);
                }
                document.body.removeChild(input);
              });
            });

            reconcileBtn.addEventListener("click", () => {
              reconcileArea.style.display = "block";
            });

            submitBtn.addEventListener("click", () => {
              const receiptValue = receiptInput.value.trim();

              let errorMessage = container.querySelector(".error-message");
              if (errorMessage) {
                errorMessage.remove();
              }

              if (
                receiptValue === "" ||
                isNaN(receiptValue) ||
                receiptValue <= 0
              ) {
                errorMessage = document.createElement("p");
                errorMessage.className = "error-message";
                errorMessage.innerText = "Please enter a valid receipt amount.";
                errorMessage.style.cssText = `
                                  color: red;
                                  font-size: 0.9rem;
                                  margin-top: 10px;
                              `;
                container.appendChild(errorMessage);
                return;
              }

              container.innerHTML = `<p>Task completed and cleared.</p>`;
            });

            resultsSection.appendChild(container);
          });
        });
      }
    </script>
  </body>
</html>
